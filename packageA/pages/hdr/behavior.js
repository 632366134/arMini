"use strict";var t=require("../chunks/three-platformize3.js");class e extends t.DataTextureLoader{constructor(e){super(e),this.type=t.HalfFloatType}parse(e){const n=function(t,e){switch(t){case 1:console.error("THREE.RGBELoader Read Error: "+(e||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(e||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(e||""));break;default:console.error("THREE.RGBELoader: Error: "+(e||""))}return-1},s=function(t,e,n){e=e||1024;let s=t.pos,i=-1,r=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));for(;0>(i=o.indexOf("\n"))&&r<e&&s<t.byteLength;)a+=o,r+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));return-1<i&&(!1!==n&&(t.pos+=r+i+1),a+o.slice(0,i))},i=function(t,e,n,s){const i=t[e+3],r=Math.pow(2,i-128)/255;n[s+0]=t[e+0]*r,n[s+1]=t[e+1]*r,n[s+2]=t[e+2]*r},r=function(e,n,s,i){const r=e[n+3],a=Math.pow(2,r-128)/255;s[i+0]=t.DataUtils.toHalfFloat(Math.min(e[n+0]*a,65504)),s[i+1]=t.DataUtils.toHalfFloat(Math.min(e[n+1]*a,65504)),s[i+2]=t.DataUtils.toHalfFloat(Math.min(e[n+2]*a,65504))},a=new Uint8Array(e);a.pos=0;const o=function(t){const e=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let c,h;if(t.pos>=t.byteLength||!(c=s(t)))return n(1,"no header found");if(!(h=c.match(/^#\?(\S+)/)))return n(3,"bad initial token");for(o.valid|=1,o.programtype=h[1],o.string+=c+"\n";c=s(t),!1!==c;)if(o.string+=c+"\n","#"!==c.charAt(0)){if((h=c.match(e))&&(o.gamma=parseFloat(h[1],10)),(h=c.match(i))&&(o.exposure=parseFloat(h[1],10)),(h=c.match(r))&&(o.valid|=2,o.format=h[1]),(h=c.match(a))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=c+"\n";return 2&o.valid?4&o.valid?o:n(3,"missing image size specifier"):n(3,"missing format specifier")}(a);if(-1!==o){const e=o.width,s=o.height,c=function(t,e,s){const i=e;if(i<8||i>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);if(i!==(t[2]<<8|t[3]))return n(3,"wrong scanline width");const r=new Uint8Array(4*e*s);if(!r.length)return n(4,"unable to allocate buffer space");let a=0,o=0;const c=4*i,h=new Uint8Array(4),l=new Uint8Array(c);let d=s;for(;d>0&&o<t.byteLength;){if(o+4>t.byteLength)return n(1);if(h[0]=t[o++],h[1]=t[o++],h[2]=t[o++],h[3]=t[o++],2!=h[0]||2!=h[1]||(h[2]<<8|h[3])!=i)return n(3,"bad rgbe scanline format");let e,s=0;for(;s<c&&o<t.byteLength;){e=t[o++];const i=e>128;if(i&&(e-=128),0===e||s+e>c)return n(3,"bad scanline data");if(i){const n=t[o++];for(let t=0;t<e;t++)l[s++]=n}else l.set(t.subarray(o,o+e),s),s+=e,o+=e}const u=i;for(let t=0;t<u;t++){let e=0;r[a]=l[t+e],e+=i,r[a+1]=l[t+e],e+=i,r[a+2]=l[t+e],e+=i,r[a+3]=l[t+e],a+=4}d--}return r}(a.subarray(a.pos),e,s);if(-1!==c){let n,a,h,l;switch(this.type){case t.UnsignedByteType:n=c,a=t.RGBEFormat,h=t.UnsignedByteType;break;case t.FloatType:l=c.length/4;const e=new Float32Array(3*l);for(let t=0;t<l;t++)i(c,4*t,e,3*t);n=e,a=t.RGBFormat,h=t.FloatType;break;case t.HalfFloatType:l=c.length/4;const s=new Uint16Array(3*l);for(let t=0;t<l;t++)r(c,4*t,s,3*t);n=s,a=t.RGBFormat,h=t.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:s,data:n,header:o.string,gamma:o.gamma,exposure:o.exposure,format:a,type:h}}}return null}setDataType(t){return this.type=t,this}load(e,n,s,i){return super.load(e,(function(e,s){switch(e.type){case t.UnsignedByteType:e.encoding=t.RGBEEncoding,e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case t.FloatType:case t.HalfFloatType:e.encoding=t.LinearEncoding,e.minFilter=t.LinearFilter,e.magFilter=t.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}n&&n(e,s)}),s,i)}}class n{constructor(t,e){this.parts=t,this.options=e}}for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(256),r=0;r<s.length;r++)i[s.charCodeAt(r)]=r;class a{createObjectURL(t){if(t instanceof n){const e=function(t){for(var e,n="",i=new Uint8Array(t),r=i.byteLength,a=r%3,o=r-a,c=0;c<o;c+=3)e=i[c]<<16|i[c+1]<<8|i[c+2],n+=s[(16515072&e)>>18]+s[(258048&e)>>12]+s[(4032&e)>>6]+s[63&e];return 1==a?(e=i[o],n+=s[(252&e)>>2]+s[(3&e)<<4]+"=="):2==a&&(e=i[o]<<8|i[o+1],n+=s[(64512&e)>>10]+s[(1008&e)>>4]+s[(15&e)<<2]+"="),n}(t.parts[0]);return`data:${t.options.type};base64,${e}`}return""}revokeObjectURL(){}}function o(t){if((t=(t=`${t}`).replace(/[ \t\n\f\r]/g,"")).length%4==0&&(t=t.replace(/==?$/,"")),t.length%4==1||/[^+/0-9A-Za-z]/.test(t))return null;let e="",n=0,s=0;for(let i=0;i<t.length;i++)n<<=6,n|=c(t[i]),s+=6,24===s&&(e+=String.fromCharCode((16711680&n)>>16),e+=String.fromCharCode((65280&n)>>8),e+=String.fromCharCode(255&n),n=s=0);return 12===s?(n>>=4,e+=String.fromCharCode(n)):18===s&&(n>>=2,e+=String.fromCharCode((65280&n)>>8),e+=String.fromCharCode(255&n)),e}function c(t){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(t);return e<0?void 0:e}const h=new WeakMap;class l{constructor(t){this.identifier=t.identifier,this.force=void 0===t.force?1:t.force,this.pageX=void 0===t.pageX?t.x:t.pageX,this.pageY=void 0===t.pageY?t.y:t.pageY,this.clientX=void 0===t.clientX?t.x:t.clientX,this.clientY=void 0===t.clientY?t.y:t.clientY,this.screenX=this.pageX,this.screenY=this.pageY}}class d{constructor(){h.set(this,{})}addEventListener(t,e,n={}){let s=h.get(this);s||(s={},h.set(this,s)),s[t]||(s[t]=[]),s[t].push(e),n.capture,n.once,n.passive}removeEventListener(t,e){const n=h.get(this);if(n){const s=n[t];if(s&&s.length>0)for(let t=s.length;t--;t>0)if(s[t]===e){s.splice(t,1);break}}}dispatchEvent(t={}){"function"!=typeof t.preventDefault&&(t.preventDefault=()=>{}),"function"!=typeof t.stopPropagation&&(t.stopPropagation=()=>{});const e=h.get(this);if(e){const n=e[t.type];if(n)for(let e=0;e<n.length;e++)n[e](t)}}releasePointerCapture(){}setPointerCapture(){}}const u=new WeakMap,p=new WeakMap,f=new WeakMap;function g(t,e={}){e.target=e.target||this,"function"==typeof this[`on${t}`]&&this[`on${t}`].call(this,e)}function m(t,e={}){this.readyState=t,e.readyState=t,g.call(this,"readystatechange",e)}const{platform:y}=wx.getSystemInfoSync();class v extends d{constructor(){super(),this.onabort=null,this.onerror=null,this.onload=null,this.onloadstart=null,this.onprogress=null,this.ontimeout=null,this.onloadend=null,this.onreadystatechange=null,this.readyState=0,this.response=null,this.responseText=null,this.responseType="text",this.dataType="string",this.responseXML=null,this.status=0,this.statusText="",this.upload={},this.withCredentials=!1,u.set(this,{"content-type":"application/x-www-form-urlencoded"}),p.set(this,{})}abort(){const t=f.get(this);t&&t.abort()}getAllResponseHeaders(){const t=p.get(this);return Object.keys(t).map((e=>`${e}: ${t[e]}`)).join("\n")}getResponseHeader(t){return p.get(this)[t]}open(t,e){this._method=t,this._url=e,m.call(this,v.OPENED)}overrideMimeType(){}send(t=""){if(this.readyState!==v.OPENED)throw new Error("Failed to execute 'send' on 'XMLHttpRequest': The object's state must be OPENED.");{const n=this._url,s=u.get(this),i=this.responseType,r=this.dataType,a=function(t){return!/^(http|https|ftp|wxfile):\/\/.*/i.test(t)}(n);let o;"arraybuffer"===i||(o="utf8"),delete this.response,this.response=null;let c=!1;const h=({data:t,statusCode:e,header:n})=>{if(!c){if(c=!0,e=void 0===e?200:e,"string"!=typeof t&&!(t instanceof ArrayBuffer))try{t=JSON.stringify(t)}catch(t){}this.status=e,n&&p.set(this,n),g.call(this,"loadstart"),m.call(this,v.HEADERS_RECEIVED),m.call(this,v.LOADING),this.response=t,t instanceof ArrayBuffer?Object.defineProperty(this,"responseText",{enumerable:!0,configurable:!0,get:function(){throw"InvalidStateError : responseType is "+this.responseType}}):this.responseText=t,m.call(this,v.DONE),g.call(this,"load"),g.call(this,"loadend")}},l=({errMsg:t})=>{c||(c=!0,-1!==t.indexOf("abort")?g.call(this,"abort"):g.call(this,"error",{message:t}),g.call(this,"loadend"),a&&console.warn(t))};if(a){const t=wx.getFileSystemManager();var e={filePath:n,success:h,fail:l};return o&&(e.encoding=o),void t.readFile(e)}const d="arraybuffer"===i&&"ios"===y&&v.useFetchPatch;wx.request({data:t,url:n,method:this._method,header:s,dataType:r,responseType:i,enableCache:!1,success:h,fail:l}),d&&setTimeout((function(){wx.request({data:t,url:n,method:this._method,header:s,dataType:r,responseType:i,enableCache:!0,success:h,fail:l})}),v.fetchPatchDelay)}}setRequestHeader(t,e){const n=u.get(this);n[t]=e,u.set(this,n)}addEventListener(t,e){"function"==typeof e&&(this["on"+t]=(t={})=>{t.target=t.target||this,e.call(this,t)})}removeEventListener(t,e){this["on"+t]===e&&(this["on"+t]=null)}}function w(t){return t=(t=t.trim()).replace(/<!--[\s\S]*?-->/g,""),{declaration:e(),root:n()};function e(){if(!i(/^<\?xml\s*/))return;const t={attributes:{}};for(;!r()&&!a("?>");){const e=s();if(!e)return t;t.attributes[e.name]=e.value}return i(/\?>\s*/),i(/<!DOCTYPE[^>]*>\s/),t}function n(){const t=i(/^<([\w-:.]+)\s*/);if(!t)return;const e={name:t[1],attributes:{},children:[]};for(;!(r()||a(">")||a("?>")||a("/>"));){const t=s();if(!t)return e;e.attributes[t.name]=t.value}if(i(/^\s*\/>\s*/))return e;let o;for(i(/\??>\s*/),e.content=function(){const t=i(/^([^<]*)/);return t?t[1]:""}();o=n();)e.children.push(o);return i(/^<\/[\w-:.]+>\s*/),e}function s(){const t=i(/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/);var e;if(t)return{name:t[1],value:(e=t[2],e.replace(/^['"]|['"]$/g,""))}}function i(e){const n=t.match(e);if(n)return t=t.slice(n[0].length),n}function r(){return 0==t.length}function a(e){return 0==t.indexOf(e)}}function b(t,e){e(t),t.children.forEach((t=>b(t,e)))}v.UNSEND=0,v.OPENED=1,v.HEADERS_RECEIVED=2,v.LOADING=3,v.DONE=4,v.useFetchPatch=!1,v.fetchPatchDelay=200;class E{parseFromString(t){const e=w(t),n={hasAttribute(t){return void 0!==this.attributes[t]},getAttribute(t){return this.attributes[t]},getElementsByTagName(t){const e=[];return this.childNodes.forEach((n=>b(n,(n=>t===n.name&&e.push(n))))),e}};b(e.root,(t=>{t.nodeType=1,t.nodeName=t.name,t.style=new Proxy((t.attributes.style||"").split(";").reduce(((t,e)=>{if(e){let[n,s]=e.split(":");t[n.trim()]=s.trim()}return t}),{}),{get:(t,e)=>t[e]||""}),t.textContent=t.content,t.childNodes=t.children,t.__proto__=n}));const s={documentElement:e.root,childNodes:[e.root]};return s.__proto__=n,s}}class x{decode(t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));let e="";for(let n=0,s=t.length;n<s;n++)e+=String.fromCharCode(t[n]);try{return decodeURIComponent(escape(e))}catch(t){return e}}}function _(){return wx.createOffscreenCanvas()}class T{constructor(t,e,n){const s=wx.getSystemInfoSync(),i="android"===s.platform;this.canvas=t,this.canvasW=void 0===e?t.width:e,this.canvasH=void 0===n?t.height:n,this.document={createElementNS:(e,n)=>"canvas"===n?t:"img"===n?t.createImage():void 0},this.window={innerWidth:s.windowWidth,innerHeight:s.windowHeight,devicePixelRatio:s.pixelRatio,URL:new a,AudioContext:function(){},requestAnimationFrame:this.canvas.requestAnimationFrame,cancelAnimationFrame:this.canvas.cancelAnimationFrame,DeviceOrientationEvent:{requestPermission:()=>Promise.resolve("granted")},DOMParser:E,TextDecoder:x},[this.canvas,this.document,this.window].forEach((t=>{const e=t.__proto__;t.__proto__={},t.__proto__.__proto__=e,function(t,e){for(let n of Object.getOwnPropertyNames(e))if("constructor"!==n&&"prototype"!==n&&"name"!==n){let s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s)}}(t.__proto__,d.prototype)})),this.patchCanvas(),this.onDeviceMotionChange=t=>{t.type="deviceorientation",i&&(t.alpha*=-1,t.beta*=-1,t.gamma*=-1),this.window.dispatchEvent(t)}}patchCanvas(){const{canvasH:t,canvasW:e}=this;Object.defineProperty(this.canvas,"style",{get(){return{width:this.width+"px",height:this.height+"px"}}}),Object.defineProperty(this.canvas,"clientHeight",{get(){return t||this.height}}),Object.defineProperty(this.canvas,"clientWidth",{get(){return e||this.width}}),this.canvas.ownerDocument=this.document}patchXHR(){return v.useFetchPatch=!0,this}getGlobals(){return{atob:o,Blob:n,window:this.window,document:this.document,HTMLCanvasElement:void 0,XMLHttpRequest:v,OffscreenCanvas:_,createImageBitmap:void 0}}enableDeviceOrientation(t){return new Promise(((e,n)=>{wx.onDeviceMotionChange(this.onDeviceMotionChange),wx.startDeviceMotionListening({interval:t,success:t=>{e(t),this.enabledDeviceMotion=!0},fail:n})}))}disableDeviceOrientation(){return new Promise(((t,e)=>{wx.offDeviceMotionChange(this.onDeviceMotionChange),this.enabledDeviceMotion&&wx.stopDeviceMotionListening({success:()=>{t(),this.enabledDeviceMotion=!1},fail:e})}))}dispatchTouchEvent(t={}){const e={...this},n=t.changedTouches.map((t=>new l(t))),s={changedTouches:n,touches:t.touches.map((t=>new l(t))),targetTouches:Array.prototype.slice.call(t.touches.map((t=>new l(t)))),timeStamp:t.timeStamp,target:e,currentTarget:e,type:t.type,cancelBubble:!1,cancelable:!1};if(this.canvas.dispatchEvent(s),n.length){const e=n[0],s={pageX:e.pageX,pageY:e.pageY,pointerId:e.identifier,type:{touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup"}[t.type],pointerType:"touch"};this.canvas.dispatchEvent(s)}}dispose(){this.disableDeviceOrientation(),this.canvas.width=0,this.canvas.height=0,this.canvas&&(this.canvas.ownerDocument=null),this.onDeviceMotionChange=null,this.document=null,this.window=null,this.canvas=null}}module.exports=function(){return Behavior({data:{width:1,height:1,fps:0,memory:0,cpu:0,list:[]},methods:{onReady(){console.log("onReady2"),wx.createSelectorQuery().select("#webgl").node().exec((t=>{this.canvas=t[0].node;const e=wx.getSystemInfoSync(),n=e.pixelRatio;((t,e)=>{console.log(`canvas size: width = ${t} , height = ${e}`),this.canvas.width=t*n/2,this.canvas.height=e*n/2,this.setData({width:t,height:e})})(e.windowWidth,e.windowHeight),this.initVK()}))},onUnload(){t.PLATFORM&&t.PLATFORM.dispose(),this._texture&&(this._texture.dispose(),this._texture=null),this.renderer&&(this.renderer.dispose(),this.renderer=null),this.scene&&(this.scene.dispose(),this.scene=null),this.camera&&(this.camera=null),this.model&&(this.model=null),this._insertModel&&(this._insertModel=null),this._insertModels&&(this._insertModels=null),this.planeBox&&(this.planeBox=null),this.mixers&&(this.mixers.forEach((t=>t.uncacheRoot(t.getRoot()))),this.mixers=null),this.clock&&(this.clock=null),this.THREE&&(this.THREE=null),this._tempTexture&&this._tempTexture.gl&&(this._tempTexture.gl.deleteTexture(this._tempTexture),this._tempTexture=null),this._fb&&this._fb.gl&&(this._fb.gl.deleteFramebuffer(this._fb),this._fb=null),this._program&&this._program.gl&&(this._program.gl.deleteProgram(this._program),this._program=null),this.canvas&&(this.canvas=null),this.gl&&(this.gl=null),this.session&&(this.session=null),this.anchor2DList&&(this.anchor2DList=[])},initVK(){this.initTHREE();const t=this.THREE;this.init&&this.init(),console.log("this.gl",this.gl);const n=wx.isVKSupport("v2"),s=this.session=wx.createVKSession({track:{plane:{mode:3},marker:!0},version:n?"v2":"v1",gl:this.gl});s.start((n=>{if(n)return console.error("VK error: ",n);console.log("@@@@@@@@ VKSession.version",s.version),this.canvas;const i=(t,e,n)=>{console.log(`canvas size: width = ${t} , height = ${e}`),this.canvas.width=t*n/2,this.canvas.height=e*n/2,this.setData({width:t,height:e})};(new e).load("http://www.yanhuangxueyuan.com/threejs/examples/textures/equirectangular/venice_sunset_2k.hdr",(e=>{console.log(e),e.mapping=t.EquirectangularReflectionMapping,this.scene.background=e,this.scene.environment=e}));new t.OrbitControls(this.camera,this.canvas).enableDamping=!0;const r=new t.AxesHelper(5);this.scene.add(r),s.on("resize",(()=>{const t=wx.getSystemInfoSync();i(t.windowWidth,.8*t.windowHeight,t.pixelRatio)}));const a=(t,e)=>{t.matrixAutoUpdate=!1,t.matrix.fromArray(e)};s.on("addAnchors",(e=>{e.forEach((e=>{const n=e.size;let s;{s=new t.Object3D;const e=this.model;e.rotateX(-Math.PI/2),s.add(e)}s._id=e.id,s._size=n,a(s,e.transform),this.planeBox.add(s)}))})),s.on("updateAnchors",(t=>{const e=t.reduce(((t,e)=>(t[e.id]=e,t)),{});this.planeBox.children.forEach((t=>{if(t._id&&e[t._id]){const n=e[t._id],s=n.size;0,t._id=n.id,t._size=s,a(t,n.transform)}}))})),s.on("removeAnchors",(t=>{const e=t.reduce(((t,e)=>(t[e.id]=e,t)),{});this.planeBox.children.forEach((t=>{t._id&&e[t._id]&&this.planeBox.remove(t)}))}));const o=this.planeBox=new t.Object3D;this.scene.add(o)})),this.clock=new t.Clock;const i=t=>{const e=s.getVKFrame(this.canvas.width,this.canvas.height);e&&this.render(e),s.requestAnimationFrame(i)};s.requestAnimationFrame(i)},initTHREE(){const e=new T(this.canvas);this.platform=e,e.enableDeviceOrientation("game"),t.PLATFORM.set(e),this.THREE=t.THREE;const n=this.camera=new t.Camera;n.position.set(0,0,10);const s=this.scene=new t.Scene;s.add(n);const i=new t.HemisphereLight(16777215,4473924);i.position.set(0,.2,0),s.add(i);const r=new t.DirectionalLight(16777215);r.position.set(0,.2,.1),s.add(r);(this.renderer=new t.WebGL1Renderer({antialias:!0,alpha:!0})).gammaFactor=2.2}}})};
